//-----------------------------------------------------
//- pingpong.js - Javascript Messaging Library
//- Copyright 2012 Ohgyun Ahn (ohgyun@gmail.com)
//- MIT Licensed
//-
//- https://github.com/ohgyun/pingpong
//-----------------------------------------------------
(function(l){var g={version:"0.1",subscribe:function(a,b,d){var f=new c(a),a=new k(a,b,d);i.register(f,a)},publish:function(a){var b=new c(a),d=Array.prototype.slice.call(arguments,1);d.push(a);i.runHandlers(b,d)},unsubscribe:function(a,b){var d=new c(a);i.remove(d,b)},ping:function(){this.publish.apply(this,arguments)},pong:function(){this.subscribe.apply(this,arguments)},pung:function(){this.unsubscribe.apply(this,arguments)},channel:function(a){return h.getInstance(a)}},h=function(a){this._channel=
a},m=h.prototype;h._instances={};h.getInstance=function(a){var b=this._instances;b[a]=b[a]||new h(a);return b[a]};(function(){for(var a in g)g.hasOwnProperty(a)&&"function"===typeof g[a]&&function(a){m[a]=function(){var d=this._channel+c.SEPERATOR+(arguments[0]||""),f=Array.prototype.slice.call(arguments,1);f.unshift(d);return g[a].apply(g,f)}}(a)})();var c=function(a){this._topic=a;this._topicPieces=a.split(c.SEPERATOR);this.validate()},e=c.prototype;c.SEPERATOR=".";c.WILDCARD="*";c.VALIDATOR=/^\w+$/;
e.validate=function(){this.eachTopicPiece(function(a,b){!c.VALIDATOR.test(a)&&!(b&&a===c.WILDCARD)&&n.throwError("INVALID_TOPIC")})};e.eachTopicPiece=function(a,b){var d=this._topicPieces.length,f,c;f=!1;for(var e=0;e<d&&!(f=this._topicPieces[e],c=e===d-1,f=a.call(b,f,c));e++);};var i={HANDLERS_KEY:"~handlers",_map:{},register:function(a,b){this._structureMap(a);this._findHandlers(a).add(b)},_structureMap:function(a){this._createRootWildcardHandlers();this._eachTopicPieceMap(a,function(a,d,f){f[a]=
f[a]||this._createMap()})},_createRootWildcardHandlers:function(){this._map[c.WILDCARD]=this._map[c.WILDCARD]||new j},_eachTopicPieceMap:function(a,b){var d=this._map;a.eachTopicPiece(function(a,c){b.call(this,a,c,d);d=d[a];if(!d)return!0},this)},_createMap:function(){var a={};a[c.WILDCARD]=new j;a[this.HANDLERS_KEY]=new j;return a},_findHandlers:function(a){var b=null;this._eachTopicPieceMap(a,function(a,f,e){f&&(b=a===c.WILDCARD?e[c.WILDCARD]:e[a][this.HANDLERS_KEY])});return b},runHandlers:function(a,
b){this._eachTopicPieceMap(a,function(a,f,c){this._runWildcardHandlers(c,b);this._runHandlersIfLastMsg(a,f,c,b)})},_runWildcardHandlers:function(a,b){this._runHandlers(a[c.WILDCARD],b)},_runHandlers:function(a,b){a&&a.runAll(b)},_runHandlersIfLastMsg:function(a,b,d,c){b&&(a=d[a]&&d[a][this.HANDLERS_KEY])&&this._runHandlers(a,c)},remove:function(a,b){var d=this._findHandlers(a);d&&d.remove(b)},reset:function(){this._map={}}},j=function(){this._handlers=[]},e=j.prototype;e.add=function(a){this._handlers.push(a)};
e.runAll=function(a){this.eachHandler(function(b){b.run(a)})};e.eachHandler=function(a){for(var b=this._handlers.length,d,c=0;c<b;c++)d=this._handlers[c],a.call(this,d,c)};e.remove=function(a){var b=-1;this.eachHandler(function(c,e){c.isEqual(a)&&(b=e)});-1<b&&this._handlers.splice(b,1)};var k=function(a,b,c){this._topic=a;this._handler=b;this._context=c||this},e=k.prototype;e.run=function(a){a.push(this._topic);this._handler.apply(this._context,a)};e.isEqual=function(a){return this._handler===a};
var n={throwError:function(a){throw"[pingpong] "+this[a];},INVALID_TOPIC:"Topic should be character"};g.subscribersMap=i;l.pingpong=g;"function"===typeof define&&define.amd&&define("pingpong",[],function(){return g})})(this);
